---
title: "p8105_hw6_rz2570"
author: "Ruilian Zhang"
date: "11/25/2021"
output: github_document
---

```{r}
library(tidyverse)
library(modelr)
library(mgcv)

theme_set(theme_minimal() + theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)))
```


## Problem 1

```{r import and clean data}
birth_df = read_csv("data/birthweight.csv") %>% 
  mutate(
    babysex = factor(babysex),
    frace = factor(frace),
    malform = factor(malform),
    mrace = factor(mrace)
    )

 
birth_df %>% 
  summarize_all(~ sum(is.na(.))) %>% 
  knitr::kable()
```

* Convert some numeric data to factor for regression analysis.  
* The table above shows that there are no missing values in the data.  

```{r build a regression model}
birth_df %>% 
  ggplot(aes(x = blength, y = bwt)) +
  geom_point() +
  labs(
    title = "Baby's birth weight against birth length",
    x = "Birth length",
    y = "Birth weight",
    subtitle = "A"
  )

fit = lm(bwt ~ blength, data = birth_df)

fit %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3)

birth_df %>% 
  modelr::add_residuals(., fit) %>% 
  modelr::add_predictions(., fit) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = .3) +
  labs(
    title = "Model residuals against fitted values",
    x = "Predictions",
    y = "Residuals",
    subtitle = "B"
  )
```

* Modeling process: 
  + After searching online, it seems that birth length has an association with birth weight, and birth length is used as the predictor of birth weight in some research.  
  + From plot A, we can find that baby's length at birth might have an linear association with baby's birth weight. So `blength` can be chosen as the predictor of the first linear model.  
  + A linear model was fitted, using `blength` as the predictor and `bwt` as the outcome.  
  + We can see from the statistic and p-value of the table above that the model is statistically significant.  
* Describe plot B: The plot shows the predicted values against the residuals of the model, in which the residuals are centered around 0 for most predictions ranging from 2000-4000. For predictions below 2000 and over 4000, there are some extreme outliers of residuals and the distribution of the residual gets skewed, which indicates this linear model might not be optimal for birth weight values under 2000 and over 4000.  

```{r fit two more models}
fit1 = lm(bwt ~ blength + gaweeks, data = birth_df)

fit1 %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3)

fit2 = lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = birth_df)

fit2 %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3)
```

```{r compare models}
cv_df = crossv_mc(birth_df, 10) %>% 
  mutate(
    mod1 = map(train, ~lm(bwt ~ blength, data = .x)),
    mod2 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    mod3 = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = .x))) %>% 
  mutate(
    rmse_mod1 = map2_dbl(mod1, test, ~rmse(model = .x, data = .y)),
    rmse_mod2 = map2_dbl(mod2, test, ~rmse(model = .x, data = .y)),
    rmse_mod3 = map2_dbl(mod2, test, ~rmse(model = .x, data = .y))
  )

cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) +
  geom_violin() +
  labs(
    title = "Distribution of root mean squared errors for each model",
    x = "Model",
    y = "Root mean squared errors"
  )
```


 
## Problem 2

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

